# 20230320
## ì˜¤ëŠ˜ ê³µë¶€í•œ ë‚´ìš©
## - ğŸ“‘ : Now In Android Deep Dive
# Day2

niaì˜ ì•„í‚¤í…ì³ëŠ” Official Architectureì´ë‹ˆ ê°€ì¥ ì•ˆìª½ì— ìœ„ì¹˜í•˜ëŠ” coreì˜ data ë¶€ë¶„ë¶€í„° ì‚´í´ë³´ëŠ”ê²Œ ì¢‹ì„ê±°ê°™ë‹¤. ê·¸ëŸ¬ë‚˜ ì¡°ê¸ˆ ë³´ë‹ˆ coreì˜ databaseê°€ ë” ì•ˆìª½ì— ìœ„ì¹˜í•˜ëŠ”ê±°ê°™ë‹¤. ì•„ë§ˆ dataì— ì†í•˜ëŠ” ë¶€ë¶„ ì¤‘ roomì— í¬í•¨ë˜ëŠ” ë¶€ë¶„ì€ ì´ìª½ì— ë“¤ì–´ê°„ ëª¨ì–‘ì´ë‹¤.

ë¨¼ì € model ë¶€ë¶„ë¶€í„° ì‚´í´ë³¸ë‹¤.

## Model

:core:databaseì˜ Modelì—ëŠ” Entityê°€ ì¡´ì¬í•˜ëŠ”ë° í•˜ë‚˜í•˜ë‚˜ ì‚´í´ë³´ì.

```kotlin
// @Entity ì£¼ì„ìœ¼ë¡œ roomì˜ entitiyë¼ëŠ”ê±¸ í‘œì‹œ
@Entity(
// í•´ë‹¹ entityì˜ í…Œì´ë¸” ë„¤ì„ì„ ì •í•œë‹¤.
    tableName = "news_resources",
)
data class NewsResourceEntity(
    @PrimaryKey
    val id: String,
    val title: String,
    val content: String,
    val url: String,
    @ColumnInfo(name = "header_image_url")
    val headerImageUrl: String?,
    @ColumnInfo(name = "publish_date")
    val publishDate: Instant,
    val type: NewsResourceType,
)

fun NewsResourceEntity.asExternalModel() = NewsResource(
    id = id,
    title = title,
    content = content,
    url = url,
    headerImageUrl = headerImageUrl,
    publishDate = publishDate,
    type = type,
    topics =listOf(),
)
```

entity ë¶€ë¶„ì—ì„œëŠ” í¬ê²Œ ì•Œì•„ì•¼í•˜ëŠ” ë‚´ìš©ì€ ì—†ì´ room ê¸°ë³¸ entityë‹¤.

ì•„ë˜ Entityì˜ í™•ì¥ í•¨ìˆ˜ê°€ ìˆëŠ”ë° í•´ë‹¹ í•¨ìˆ˜ëŠ” dataì˜ repositoryì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ë•Œ ì‚¬ìš©í•˜ëŠ”ë° ëª©ì ì€ Entity ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ëŠ”ê²ƒì´ ì•„ë‹Œ ë§¨ ì•„ë˜ topicsë¥¼ ë„£ì–´ í•¨ê»˜ ì‚¬ìš©í•˜ë ¤ê³  ì¶”ê°€ í•œê±°ê°™ë‹¤.

í•¨ìˆ˜ë¥¼ íƒ€ê³ íƒ€ê³  ê°€ë©´ í™•ì‹¤í•˜ê²Œ ë³´ì´ëŠ”ë° í•´ë‹¹ ë¶€ë¶„ì€ í•´ë‹¹ íŒŒíŠ¸ë¥¼ ì„¤ëª…í• ë•Œ ê°™ì´ ì„¤ëª…í•˜ëŠ”ê²Œ ë” ì¢‹ì„ê±°ê°™ë‹¤.

```kotlin
@Entity(
    tableName = "topics",
)
data class TopicEntity(
    @PrimaryKey
    val id: String,
    val name: String,
    val shortDescription: String,
    @ColumnInfo(defaultValue = "")
    val longDescription: String,
    @ColumnInfo(defaultValue = "")
    val url: String,
    @ColumnInfo(defaultValue = "")
    val imageUrl: String,
)

fun TopicEntity.asExternalModel() = Topic(
    id = id,
    name = name,
    shortDescription = shortDescription,
    longDescription = longDescription,
    url = url,
    imageUrl = imageUrl,
)

```

ìœ„ì™€ ë™ì¼í•˜ë‹¤. ê·¸ëŸ°ë° í•´ë‹¹ í™•ì¥í•¨ìˆ˜ëŠ” ë³´ë©´ ê·¸ëƒ¥ ë™ì¼í•œ Dataë¥¼ ë³´ë‚¸ë‹¤. ì‚¬ì‹¤ ì¢€ ë” ì •í™•í•˜ê²ŒëŠ” ë™ì¼í•´ ë³´ì´ëŠ” dataë‹¤. ì•„ë§ˆ í•´ë‹¹ í•¨ìˆ˜ì˜ ëª©ì ì€ entityë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ í•˜ëŠ”ê²ƒì¼ê±°ë‹¤. entityë¥¼ ë°”ë¡œ ì‚¬ìš©í•˜ë©´ databaseì™€ ì‚¬ìš©í•˜ëŠ”ê³³ì— tight couplingì´ ë˜ê²Œ ë˜ë¯€ë¡œ ê²°í•©ì„ ëŠìŠ¨í•˜ê²Œ í•˜ê¸° ìœ„í•´ Topicì´ë¼ëŠ” data classë¡œ ë¹¼ëŠ”ê±°ê°™ë‹¤.

```kotlin
data class PopulatedNewsResource(
    @Embedded
    val entity: NewsResourceEntity,
    @Relation(
        parentColumn = "id",
        entityColumn = "id",
        associateBy = Junction(
            value = NewsResourceTopicCrossRef::class,
            parentColumn = "news_resource_id",
            entityColumn = "topic_id",
        ),
    )
    val topics: List<TopicEntity>,
)

fun PopulatedNewsResource.asExternalModel() = NewsResource(
    id = entity.id,
    title = entity.title,
    content = entity.content,
    url = entity.url,
    headerImageUrl = entity.headerImageUrl,
    publishDate = entity.publishDate,
    type = entity.type,
    topics = topics.map(TopicEntity::asExternalModel),
)

```

@EmbeddedëŠ” ì´ë²ˆì— ì²˜ìŒ ë³´ëŠ”ë° ê²€ìƒ‰í•´ë³´ë‹ˆ í•´ë‹¹ í´ë˜ìŠ¤ì— Entityë¥¼ í•„ë“œë¡œ ì‚½ì…í•˜ê¸° ìœ„í•´ì„œ ì‚¬ìš©í•˜ëŠ” ì£¼ì„ì´ë‹¤. 

@Relationì€ ë¶€ëª¨ì™€ ìì‹ ê´€ê³„ë¥¼ ì •ì˜í•˜ê¸° ìœ„í•œ ì£¼ì„ì´ë‹¤.

ë­”ê°€ ì„¤ëª…ì´ ë¶€ì¡±í•´ì„œ ì¢€ë” ì°¾ì•„ë³´ì•˜ë‹¤.

ë‘ ì–´ë…¸í…Œì´ì…˜ì€ ë‹¤ëŒ€ë‹¤ ê´€ê³„ë¥¼ ê´€ë¦¬í• ë•Œ ì‚¬ìš©í•˜ëŠ”ê±°ê°™ë‹¤.

ê²°êµ­ ì—¬ê¸°ì„œ í•˜ê³ ìí•˜ëŠ”ê±´ NewsResourceEntityì™€ TopicEntityì˜ ê° idë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì ‘í•©í…Œì´ë¸”ì€ ë°˜í™˜í•˜ëŠ”ê²ƒì´ë‹¤.

ìì„¸í•œ ë‚´ìš©ì€ [room ë‹¤ëŒ€ë‹¤ ì•„í‹°í´](https://medium.com/coding-blocks/handling-many-to-many-relationship-in-android-addb60a3a3)ë¥¼ ì°¸ê³ í•˜ëŠ”ê²Œ ì¢‹ì„ê±°ê°™ë‹¤.

ì—¬ê¸°ì„œë„ entityë¥¼ ë°”ë¡œ ì‚¬ìš©í•˜ì§€ì•Šê³  data classë¡œ ë‹¤ì‹œ ë°˜í™˜í•œë‹¤.

```kotlin
@Entity(
    tableName = "news_resources_topics",
    primaryKeys = ["news_resource_id", "topic_id"],
    foreignKeys = [
        ForeignKey(
            entity = NewsResourceEntity::class,
            parentColumns = ["id"],
            childColumns = ["news_resource_id"],
            onDelete = ForeignKey.CASCADE,
        ),
        ForeignKey(
            entity = TopicEntity::class,
            parentColumns = ["id"],
            childColumns = ["topic_id"],
            onDelete = ForeignKey.CASCADE,
        ),
    ],
    indices = [
        Index(value = ["news_resource_id"]),
        Index(value = ["topic_id"]),
    ],
)
data class NewsResourceTopicCrossRef(
    @ColumnInfo(name = "news_resource_id")
    val newsResourceId: String,
    @ColumnInfo(name = "topic_id")
    val topicId: String,
)

```

ì´ì œ DBë¥¼ ì¡°ê¸ˆ ê³µë¶€í–ˆìœ¼ë©´ ê²€ìƒ‰ ì•ˆí•´ë„ ì•Œê±°ê°™ë‹¤.

primary keyë¥¼ ê°ê° Entityì˜ idë¡œ ì„¤ì •í•˜ê³ 

foreign keyë¡œ ê°ê°ì˜ idë¡œ ê´€ê³„ë¥¼ ì£¼ê³  ì‚­ì œë ë•Œ ê°™ì´ ì‚­ì œ ë˜ë„ë¡ onDeleteë¥¼ ë„£ì—ˆë‹¤.

ê·¸ë¦¬ê³  ê°ê° ì—´ì— indexë¥¼ ë„£ì–´ NewsResourceTopicCrossRefë¥¼ ë§Œë“ ë‹¤.

ê²°êµ­ ì €ì¥ë˜ëŠ”ê±´ idë“¤ì´ì§€ë§Œ í•´ë‹¹ í´ë˜ìŠ¤ë¡œ ê° Entityë¥¼ ì—°ê´€ì§€ì–´ ì°¾ì„ìˆ˜ìˆê²Œ ëœë‹¤.

## DAO

ì—¬ê¸°ì„œ daoëŠ” ê° Entityì˜ ê°œìˆ˜ë§Œí¼ ì¡´ì¬í•œë‹¤.

```kotlin
@Dao
interface TopicDao {
    @Query(
        value = """
        SELECT * FROM topics
        WHERE id = :topicId
    """,
    )
    fun getTopicEntity(topicId: String): Flow<TopicEntity>

    @Query(value = "SELECT * FROM topics")
    fun getTopicEntities(): Flow<List<TopicEntity>>

    @Query(
        value = """
        SELECT * FROM topics
        WHERE id IN (:ids)
    """,
    )
    fun getTopicEntities(ids: Set<String>): Flow<List<TopicEntity>>

/**
     * Inserts[topicEntities] into the db if they don't exist, and ignores those that do
     */
@Insert(onConflict = OnConflictStrategy.IGNORE)
    suspend fun insertOrIgnoreTopics(topicEntities: List<TopicEntity>): List<Long>

/**
     * Updates[entities] in the db that match the primary key, and no-ops if they don't
     */
@Update
    suspend fun updateTopics(entities: List<TopicEntity>)

/**
     * Inserts or updates[entities] in the db under the specified primary keys
     */
@Upsert
    suspend fun upsertTopics(entities: List<TopicEntity>)

/**
     * Deletes rows in the db matching the specified[ids]
*/
@Query(
        value = """
            DELETE FROM topics
            WHERE id in (:ids)
        """,
    )
    suspend fun deleteTopics(ids: List<String>)
}

```

ê° í•¨ìˆ˜ë³„ë¡œ ì£¼ì„ì´ ìˆì–´ì„œ ë¬´ìŠ¨ ì˜ë¯¸ì¸ì§€ ì•Œìˆ˜ìˆê³  ì‚¬ì‹¤ ì–´ë ¤ìš´ê±° ì—†ëŠ” ê¸°ë³¸ room daoë‹¤.

ê·¼ë° upsertê°€ ê³µì‹ì ìœ¼ë¡œ ì§€ì›í•˜ëŠ”ì§€ëŠ” ì²˜ìŒ ì•Œì•˜ë‹¤.

```kotlin
@Dao
interface NewsResourceDao {

/**
     * Fetches news resources that match the query parameters
     */
@Transaction
    @Query(
        value = """
            SELECT * FROM news_resources
            WHERE
                CASE WHEN :useFilterNewsIds
                    THEN id IN (:filterNewsIds)
                    ELSE 1
                END
             AND
                CASE WHEN :useFilterTopicIds
                    THEN id IN
                        (
                            SELECT news_resource_id FROM news_resources_topics
                            WHERE topic_id IN (:filterTopicIds)
                        )
                    ELSE 1
                END
            ORDER BY publish_date DESC
    """,
    )
    fun getNewsResources(
        useFilterTopicIds: Boolean = false,
        filterTopicIds: Set<String> =emptySet(),
        useFilterNewsIds: Boolean = false,
        filterNewsIds: Set<String> =emptySet(),
    ): Flow<List<PopulatedNewsResource>>

/**
     * Inserts[entities] into the db if they don't exist, and ignores those that do
     */
@Insert(onConflict = OnConflictStrategy.IGNORE)
    suspend fun insertOrIgnoreNewsResources(entities: List<NewsResourceEntity>): List<Long>

/**
     * Updates[entities] in the db that match the primary key, and no-ops if they don't
     */
@Update
    suspend fun updateNewsResources(entities: List<NewsResourceEntity>)

/**
     * Inserts or updates[newsResourceEntities] in the db under the specified primary keys
     */
@Upsert
    suspend fun upsertNewsResources(newsResourceEntities: List<NewsResourceEntity>)

    @Insert(onConflict = OnConflictStrategy.IGNORE)
    suspend fun insertOrIgnoreTopicCrossRefEntities(
        newsResourceTopicCrossReferences: List<NewsResourceTopicCrossRef>,
    )

/**
     * Deletes rows in the db matching the specified[ids]
*/
@Query(
        value = """
            DELETE FROM news_resources
            WHERE id in (:ids)
        """,
    )
    suspend fun deleteNewsResources(ids: List<String>)
}

```

ì¡°ê¸ˆ ì–´ë ¤ì›Œ ë³´ì´ì§€ë§Œ ê·¸ëƒ¥ WHEREì ˆì— CASEë¬¸ë§Œ ì¶”ê°€ ëœê²ƒ ì •ë„ê°€ ëˆˆì— ë„ê³  ê·¸ë¦¬ê³  ê° Entityê°€ í•©ì³ì§„ `PopulatedNewsResource`ê°€ ë°˜í™˜ëœë‹¤.

ê·¸ë¦¬ê³  `insertOrIgnoreTopicCrossRefEntities` í•¨ìˆ˜ë¡œ `NewsResourceTopicCrossRef` ì— insertí•˜ëŠ” í•¨ìˆ˜ë„ ì¡´ì¬í•œë‹¤.

ê·¸ë¦¬ê³  utilë¶€ë¶„ì— Converters íŒŒì¼ì´ ìˆëŠ”ë° ê°„ë‹¨í•˜ê²Œ ì‚´í´ë³´ì

## util

```kotlin
class InstantConverter {
    @TypeConverter
    fun longToInstant(value: Long?): Instant? =
        value?.let(Instant::fromEpochMilliseconds)

    @TypeConverter
    fun instantToLong(instant: Instant?): Long? =
        instant?.toEpochMilliseconds()
}

class NewsResourceTypeConverter {
    @TypeConverter
    fun newsResourceTypeToString(value: NewsResourceType?): String? =
        value?.let(NewsResourceType::serializedName)

    @TypeConverter
    fun stringToNewsResourceType(serializedName: String?): NewsResourceType =
        serializedName.asNewsResourceType()
}

```

@TypeConverterê°€ ë°”ë¡œ ë³´ì¸ë‹¤. @TypeConverterëŠ” Roomì„ ì‚¬ìš©í• ë•Œ ê° ì›ì‹œíƒ€ì…ë§Œ ì‚¬ìš©ì´ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— í•´ë‹¹ íƒ€ì…ì„ ë³€ê²½í•˜ëŠ” ì–´ë…¸í…Œì´ì…˜ì´ ìˆëŠ”ê²ƒì´ë‹¤.

ì´ê±¸ ìƒê°í•˜ê³  ì½”ë“œë¥¼ ë³´ë©´ Instant â†” Long ê·¸ë¦¬ê³  newResource â†” String íƒ€ì… ë³€í™˜í•˜ëŠ” Converterì´ë‹¤.

ê·¼ë° Instantë¼ëŠ” íƒ€ì…ì€ ì²˜ìŒë³¸ë‹¤.

ê²€ìƒ‰í•´ë³´ë‹ˆ datatimeê´€ë ¨ íƒ€ì…ì´ê³  ì‹œê°„ì„ ê¸°ê³„ì ìœ¼ë¡œ ë³´ê¸° ìœ„í•´ì„œ í”íˆ ìš°ë¦¬ê°€ ì‚¬ìš©í•˜ëŠ” 1970.01.01 00ì‹œ 00ë¶„ 00ì´ˆ ë¶€í„° ì—°ì‚°í•˜ëŠ” íƒ€ì…ì´ë‹¤.

ì´ì œ ë””ë ‰í† ë¦¬ ë°–ì— ìˆëŠ” íŒŒì¼ì„ í•˜ë‚˜í•˜ë‚˜ ë³´ì

## Database

```kotlin
@Database(
    entities = [
        NewsResourceEntity::class,
        NewsResourceTopicCrossRef::class,
        TopicEntity::class,
    ],
    version = 12,
    autoMigrations = [
        AutoMigration(from = 1, to = 2),
        AutoMigration(from = 2, to = 3, spec = DatabaseMigrations.Schema2to3::class),
        AutoMigration(from = 3, to = 4),
        AutoMigration(from = 4, to = 5),
        AutoMigration(from = 5, to = 6),
        AutoMigration(from = 6, to = 7),
        AutoMigration(from = 7, to = 8),
        AutoMigration(from = 8, to = 9),
        AutoMigration(from = 9, to = 10),
        AutoMigration(from = 10, to = 11, spec = DatabaseMigrations.Schema10to11::class),
        AutoMigration(from = 11, to = 12, spec = DatabaseMigrations.Schema11to12::class),
    ],
    exportSchema = true,
)
@TypeConverters(
    InstantConverter::class,
    NewsResourceTypeConverter::class,
)
abstract class NiaDatabase : RoomDatabase() {
    abstract fun topicDao(): TopicDao
    abstract fun newsResourceDao(): NewsResourceDao
}

```

roomì˜ databaseëŠ” ë²„ì „ì´ í•„ìš”í•˜ë‹¤. ê·¸ë¦¬ê³  `autoMigrations`ì€ ì—…ë°ì´íŠ¸í• ë•Œ ë§ˆë‹¤ ë¶ˆí•„ìš”í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ í¸ë¦¬í•˜ê²Œ ìë™ìœ¼ë¡œ í•´ì£¼ëŠ” í•¨ìˆ˜ë‹¤.

exportSchemaì€ ë²„ì „ ìë™ ì´ì „ì„ ìœ„í•´ ì¡´ì¬í•˜ëŠ”ê±°ê°™ë‹¤.

ê·¸ë¦¬ê³  ìœ„ì—ì„œ ì„¤ëª…í•œ TypeConvertersê°€ ìˆê³  ë§ˆì§€ë§‰ì— databaseë¥¼ ì„ ì–¸í•˜ê³  ê° daoê°€ ë‹´ê²¨ìˆë‹¤.

## DatabaseMigrations

```kotlin
object DatabaseMigrations {

    @RenameColumn(
        tableName = "topics",
        fromColumnName = "description",
        toColumnName = "shortDescription",
    )
    class Schema2to3 : AutoMigrationSpec

    @DeleteColumn(
        tableName = "news_resources",
        columnName = "episode_id",
    )
    @DeleteTable.Entries(
        DeleteTable(
            tableName = "episodes_authors",
        ),
        DeleteTable(
            tableName = "episodes",
        ),
    )
    class Schema10to11 : AutoMigrationSpec

    @DeleteTable.Entries(
        DeleteTable(
            tableName = "news_resources_authors",
        ),
        DeleteTable(
            tableName = "authors",
        ),
    )
    class Schema11to12 : AutoMigrationSpec
}

```

ìœ„ì—ì„œ ë³¸ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‚¬ì–‘ì„ ì •ì˜í•´ë‘” íŒŒì¼ì´ë‹¤.

ê°ê° ì»¬ëŸ¼ëª…ì´ ë³€ê²½ë˜ê±°ë‚˜ ì»¬ëŸ¼ì´ ì‚­ì œëœ ë‚´ì—­ë“¤ì´ ìˆë‹¤.

## Modules

ë§ˆì§€ë§‰ ëª¨ë“ˆ ë¶€ë¶„ì´ë‹¤. ë‘˜ë‹¤ hiltë¥¼ í†µí•´ ì£¼ì…ë˜ê³  ìˆê³  ë”±íˆ íŠ¹ë³„í•œ ê±´ ì—†ì´ ê·¸ëƒ¥ ì£¼ì…í•˜ëŠ” ì½”ë“œë‹¤.

## ëŠë‚€ì 
Roomì— ëŒ€í•´ ë§ì€ ê³µë¶€ê°€ ë˜ì—ˆë‹¤.
DBë‚˜ Roomì€ ê·¸ë˜ë„ ê¸°ë³¸ì´ë¼ ì–´ëŠì •ë„ ì•ˆë‹¤ê³  ìƒê°í–ˆëŠ”ë°, ì—­ì‹œ ì•„ì§ ëª¨ë¥´ëŠ”ê²ƒë“¤ì´ ë§ë‹¤.

## ë‚´ì¼ í•  ì¼
nia coreì˜ dataë¥¼ ì‚´í´ë³¼ê²ƒì´ë‹¤.