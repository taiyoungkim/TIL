# 20230320
## ì˜¤ëŠ˜ ê³µë¶€í•œ ë‚´ìš©
## - ğŸ“‘ : Now In Android Deep Dive
# Day5 (2023.04.03)

domain ë¶€ë¶„ì„ ì•Œì•„ë³´ì

coreì˜ domainì€ ì œë²• ê°„ë‹¨í•˜ë‹¤.

## Model

```kotlin
/**
 * A[topic] with the additional information for whether or not it is followed.
 */
data class FollowableTopic( //TODO consider changing to UserTopic and flattening
val topic: Topic,
    val isFollowed: Boolean,
)

```

íŒ”ë¡œìš° ê°€ëŠ¥í•œ responseì— ëŒ€í•œ data classì´ë‹¤. í•´ë‹¹ í´ë˜ìŠ¤ì— ëŒ€í•œ ì‚¬ìš©ì€ ë’¤ì— useCaseì—ì„œ ë” ì•Œì•„ë³´ì.

```kotlin
/**
 * A[NewsResource] with additional user information such as whether the user is following the
 * news resource's topics and whether they have saved (bookmarked) this news resource.
 */
data class UserNewsResource internal constructor(
    val id: String,
    val title: String,
    val content: String,
    val url: String,
    val headerImageUrl: String?,
    val publishDate: Instant,
    val type: NewsResourceType,
    val followableTopics: List<FollowableTopic>,
    val isSaved: Boolean,
) {
    constructor(newsResource: NewsResource, userData: UserData) : this(
        id = newsResource.id,
        title = newsResource.title,
        content = newsResource.content,
        url = newsResource.url,
        headerImageUrl = newsResource.headerImageUrl,
        publishDate = newsResource.publishDate,
        type = newsResource.type,
        followableTopics = newsResource.topics.map{topic->
FollowableTopic(
                topic = topic,
                isFollowed = userData.followedTopics.contains(topic.id),
            )
},
        isSaved = userData.bookmarkedNewsResources.contains(newsResource.id),
    )
}

fun List<NewsResource>.mapToUserNewsResources(userData: UserData): List<UserNewsResource> {
    returnmap{UserNewsResource(it, userData)}
}

```

ì¡°ê¸ˆ ë³µì¡í•´ ë³´ì´ì§€ë§Œ ë³„ê±° ì—†ë‹¤.

`UserNewsResource`ì™€ ìœ í‹¸ë¦¬í‹° í™•ì¥ í•¨ìˆ˜ `mapToUserNewsResources`ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. `UserNewsResource` í´ë˜ìŠ¤ëŠ” `FollowableTopic` ë˜ëŠ” `NewsResource`ê°€ ì €ì¥ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€ì™€ ê°™ì€ ì¶”ê°€ `UserData`ê°€ í¬í•¨ëœ `NewsResource` ê°œì²´ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. `mapToUserNewsResources` í•¨ìˆ˜ëŠ” ì‚¬ìš©ì ë°ì´í„°ë¥¼ ê³ ë ¤í•˜ì—¬ `NewsResource` ê°ì²´ ëª©ë¡ì„ `UserNewsResource` ê°ì²´ ëª©ë¡ì— ë§¤í•‘í•˜ëŠ” ë° ì‚¬ìš©ëœë‹¤.

```kotlin
/**
 * A use case which obtains a list of topics with their followed state.
 */
class GetFollowableTopicsUseCase @Inject constructor(
    private val topicsRepository: TopicsRepository,
    private val userDataRepository: UserDataRepository,
) {
/**
     * Returns a list of topics with their associated followed state.
     *
     *@paramsortBy- the field used to sort the topics. Default NONE = no sorting.
     */
operator fun invoke(sortBy: TopicSortField =NONE): Flow<List<FollowableTopic>> {
        returncombine(
            userDataRepository.userData,
            topicsRepository.getTopics(),
        ){userData, topics->
val followedTopics = topics
                .map{topic->
FollowableTopic(
                        topic = topic,
                        isFollowed = topic.id in userData.followedTopics,
                    )
}
when (sortBy) {
NAME-> followedTopics.sortedBy{ it.topic.name}
else -> followedTopics
            }
}
}
}

enum class TopicSortField {
NONE,
NAME,
}

```

ì´ì œ domainì˜ useCaseë¥¼ ë³¼ë•Œë‹¤.

ìœ„ useCaseì—ì„œ í•˜ê³ ìí•˜ëŠ”ê±´ userDataì™€ Topicì˜ ë°ì´í„°ë¥¼ combine í•´ì£¼ëŠ”ê²ƒì´ë‹¤.

ë°©ë²•ì€ ê° `userDataRepository`,`topicsRepository` ì—ì„œ ë°ì´í„°ë¥¼ ë°›ì•„ *`combine`* í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì„œ `topics` ì—ì„œëŠ” ì§€ê¸ˆ íŒ”ë¡œìš° í•˜ëŠ” ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³  íŒ”ë¡œìš° í•˜ëŠ” ë°ì´í„°ë¥¼ ë§µí•‘í•´ì„œ `followedTopics` ë³€ìˆ˜ì— ë„£ê³  `sortBy` í•„ë“œì— ë”°ë¼ ì´ë¦„ìœ¼ë¡œ sortí• ì§€ ê·¸ëƒ¥ ë°ì´í„°ë¥¼ ë¿Œë ¤ì¤„ì§€ë¥¼ ê²°ì •í•´ì„œ ë°˜í™˜í•œë‹¤.

```kotlin
/**
 * A use case responsible for obtaining news resources with their associated bookmarked (also known
 * as "saved") state.
 */
class GetUserNewsResourcesUseCase @Inject constructor(
    private val newsRepository: NewsRepository,
    private val userDataRepository: UserDataRepository,
) {
/**
     * Returns a list of UserNewsResources which match the supplied set of topic ids.
     *
     *@paramquery- Summary of query parameters for news resources.
     */
operator fun invoke(
        query: NewsResourceQuery = NewsResourceQuery(),
    ): Flow<List<UserNewsResource>> =
        newsRepository.getNewsResources(
            query = query,
        ).mapToUserNewsResources(userDataRepository.userData)
}

private fun Flow<List<NewsResource>>.mapToUserNewsResources(
    userDataStream: Flow<UserData>,
): Flow<List<UserNewsResource>> =
filterNot{ it.isEmpty()}
.combine(userDataStream){newsResources, userData->
newsResources.mapToUserNewsResources(userData)
}

```

ìœ„ useCaseë„ `GetFollowableTopicsUseCase` ì™€ ë¹„ìŠ·í•˜ë‹¤.

ê° `newsRepository`, `userDataRepository` ì˜ ë°ì´í„°ë¥¼ ë§¤í•‘í•´ì£¼ëŠ”ê²Œ ëª©ì ì´ê³  ë°©ì‹ì€ `newsRepository` ì—ì„œ `getNewsResources` ë°ì´í„°ë¥¼ queryë¥¼ í†µí•´ `Flow<List<NewsResource>>` ë¡œ ë°›ì•„ì„œ `mapToUserNewsResources` í™•ì¥ í•¨ìˆ˜ì—ì„œ ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ `NewsResource` ë¦¬ìŠ¤íŠ¸ì™€ `userDataRepository` ì˜ `UserData` ë¥¼ ë°›ì•„ì„œ *`combine`* ìœ¼ë¡œë°›ì•„ `newsResources.*mapToUserNewsResources*` ë¡œ ë§¤í•‘í•˜ëŠ” ë¡œì§ì´ë‹¤.

ì‚¬ì‹¤ìƒ ì •ë¦¬í•´ë³´ë‹ˆ domainì—ì„œëŠ” ë°ì´í„° ë§¤í•‘ ìœ„ì£¼ì˜€ë˜ê±°ê°™ë‹¤.

ì´ì œ Commonì„ ë³´ì

## Common

ì§€ê¸ˆ ë´ì„œëŠ” coreì—ì„œ ì‚¬ìš©ë˜ëŠ” ë¶€ë¶„ì—ì„œ ì „ì²´ì ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” í•¨ìˆ˜ë‚˜ ë¡œì§ë“¤ì„ ëª¨ì•„ë‘” Utilì¸ê±°ê°™ë‹¤.

```kotlin
interface StringDecoder {
    fun decodeString(encodedString: String): String
}

```

ë¡œì§ì´ë„ê²ƒë„ ì—†ì´ ê·¸ëƒ¥ ì¸ì½”ë”©ëœ stringì„ ë””ì½”íŒ…í•˜ëŠ” ë¡œì§ì¸ë° ì¸í„°í˜ì´ìŠ¤ ë¶€ë¶„ì´ë¼ ë¡œì§ ìì²´ëŠ” ì—†ë‹¤. 

ì¶”í›„ ìƒì†ë°›ëŠ” ì½”ë“œë¥¼ ë³´ë©´ì„œ ë” ì•Œì•„ë³´ì.

```kotlin
class UriDecoder @Inject constructor() : StringDecoder {
    override fun decodeString(encodedString: String): String = Uri.decode(encodedString)
}

```

ë°”ë¡œ ê°™ì€ ë””ë ‰í† ë¦¬ì— Urië¥¼ ë””ì½”ë”©í•˜ëŠ” í´ë˜ìŠ¤ê°€ ìˆë‹¤.

ì—¬ê¸°ë„ ì–´ë ¤ìš´ ë¡œì§ì€ ì—†ëŠ”ë° ì¸ì½”ë”©ëœ stringì„ ë°›ì•„ ë‚´ë¶€ í•¨ìˆ˜ `Uri.decode` ë¥¼ í†µí•´ì„œ ë””ì½”ë”©ëœ stringì„ ë°˜í™˜í•˜ëŠ” ê°„ë‹¨í•œ ë¡œì§ì´ë‹¤.

```kotlin
@Module
@InstallIn(SingletonComponent::class)
abstract class StringDecoderModule {
    @Binds
    abstract fun bindStringDecoder(uriDecoder: UriDecoder): StringDecoder
}

```

decoderì˜ di ë¶€ë¶„ì¸ë° ì—¬ê¸°ë„ íŠ¹ë³„í•œê±´ ì—†ë‹¤.

```kotlin
@Qualifier
@Retention(RUNTIME)
annotation class Dispatcher(val niaDispatcher: NiaDispatchers)

enum class NiaDispatchers {
IO,
}

```

ì „ì— ë°°ì› ë˜ ëŒ€ë¡œ Qualifier, Retention ê·¸ëŒ€ë¡œ ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ë‚˜ì˜¤ê³  `NiaDispatchers` ë¥¼ ìƒì„±ìë¡œ ë°›ëŠ” ì–´ë…¸í…Œì´ì…˜ í´ë˜ìŠ¤ì¸ë° dispatcherëŠ” IO ë°–ì— ì—†ë‹¤.

```kotlin
@Module
@InstallIn(SingletonComponent::class)
object DispatchersModule {
    @Provides
    @Dispatcher(IO)
    fun providesIODispatcher(): CoroutineDispatcher = Dispatchers.IO
}

```

ìœ„ì—ì„œ ì„ ì–¸ëœ ì–´ë…¸í…Œì´ì…˜ì„ ì—¬ê¸°ì„œ ë°”ë¡œ ì‚¬ìš©í•œë‹¤.

IO dispatcherë§Œ ìˆì–´ì„œ nameë„ providesIODispatcher ì´ë‹¤.

```kotlin
sealed interface Result<out T> {
    data class Success<T>(val data: T) : Result<T>
    data class Error(val exception: Throwable? = null) : Result<Nothing>
    object Loading : Result<Nothing>
}

fun <T> Flow<T>.asResult(): Flow<Result<T>> {
    return this
        .map<T, Result<T>>{
Result.Success(it)
}
.onStart{emit(Result.Loading)}
.catch{emit(Result.Error(it))}
}

```

Result ë¶€ë¶„ì´ë‹¤.

í•´ë‹¹ ResultëŠ” ê²°êµ­ uiStateë¥¼ ìœ„í•œ reponseì— ëŒ€í•œ Resultë¡œ ë³´ì¸ë‹¤.

ê·¸ë˜ì„œ Resultì˜ ë°ì´í„°ë„ ì œë„¤ë¦­ìœ¼ë¡œ ë°›ê³  loadingê³¼ errorëŠ” ê·¸ëƒ¥ Notiongì„ ë°›ëŠ”ë‹¤.

í•´ë‹¹ ResultStateëŠ” TopicViewModelì—ì„œ ì‚¬ìš©í•˜ëŠ”ê±°ë¡œ ë³´ì¸ë‹¤.

ìì„¸í•œ ì‚¬ìš©ì€ viewModelì—ì„œ ë³´ê³  ì—¬ê¸°ì„  Flowë¡œ ì˜¤ëŠ” ë°ì´í„°ë¥¼ Resultë¡œ ë³€í™˜í•˜ëŠ” `<T> Flow<T>.asResult()` ë¥¼ ë³´ê³  ë§ˆë¬´ë¦¬ í•˜ì.

Flowì— map, onStart, catchë¥¼ ëª¨ë‘ í•´ì£¼ëŠ”ë° ê°ê° Success, Loading, Errorë¥¼ ë³´ë‚¸ë‹¤.

Successë©´ ê°’ì´ ì œëŒ€ë¡œ ë“¤ì–´ì˜¨ê±°ë‹ˆ resultë¥¼ Successë¡œ ë°ì´í„°ë¥¼ ë‹´ì•„ ë°˜í™˜í•˜ì—¬ viewModelì—ì„œ ê°’ì„ ë°›ì„ìˆ˜ ìˆê²Œ í–ˆë‹¤. ê·¸ë¦¬ê³  ê°ê°ì€ emitìœ¼ë¡œ ë°”ë¡œ ì´ë²¤íŠ¸ë¥¼ ë°œìƒ ì‹œì¼œ viewModelì— ì„ ì–¸ëœ ë¡œì§ëŒ€ë¡œ ë°˜ì‘í•˜ê²Œ ë§Œë“ ê±°ë¡œ ë³´ì¸ë‹¤.

## ëŠë‚€ì 
coreì˜ ê±°ëŒ€í•œ ë¶€ë¶„ì€ ì´ì œ ë‹¤ ë´ì„œ ì‚¬ì‹¤ ì–´ë ¤ìš´ ë¡œì§ì€ ì´ì œ ì—†ì—ˆë‹¤.
domainì— useCaseë¥¼ ë§ì´ ê¸°ëŒ€í–ˆëŠ”ë° ëŒ€ë¶€ë¶„ ê·¸ëƒ¥ ë§¤í•‘í•˜ëŠ” ë¡œì§ì´ì—¬ì„œ ì¢€ ì•„ì‰¬ìš´ ëŠë‚Œì´ë‹¤.

## ë‚´ì¼ í•  ì¼
niaì˜ analyticì´ë‚˜ designSystemì„ ë³¼ê±°ê°™ë‹¤.